---
- name: Populate service facts
  ansible.builtin.service_facts:

- name: Include nginx dependency
  ansible.builtin.include_role:
    name: nginx
  when: mailpit.nginx.enable

- name: Disable maildev
  ansible.builtin.include_tasks: disable-maildev.yml
  when:
    - ansible_facts['system'] == 'Linux'
    - ansible_facts['services']['maildev.service']['status'] | default('not-found') != 'not-found'

- name: Disable mailhog
  ansible.builtin.include_tasks: disable-mailhog.yml
  when:
    - ansible_facts['os_family'] == 'FreeBSD'
    - ansible_facts['services']['mailhog']['status'] | default('not-found') != 'not-found'

- name: Include dehydrated dependency
  ansible.builtin.include_role:
    name: dehydrated
  when: mailpit.dehydrated.enable

- name: Include oauth2_proxy dependency
  ansible.builtin.include_role:
    name: oauth2_proxy
  when: (mailpit.oauth2_proxy is defined and mailpit.oauth2_proxy != None)

- name: Install and configure mailpit (Linux)
  ansible.builtin.include_tasks:
    file: linux-install.yml
  when: ansible_facts['system'] == 'Linux'

- name: Configure mailpit (FreeBSD)
  ansible.builtin.include_tasks:
    file: freebsd-setup.yml
  when: ansible_facts['os_family'] == 'FreeBSD'

- name: Configure Nginx for mailpit
  ansible.builtin.include_tasks: nginx.yml
  when: mailpit.nginx.enable
